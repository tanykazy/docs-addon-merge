<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />

    <link
      href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <link
      rel="stylesheet"
      href="https://ssl.gstatic.com/docs/script/css/add-ons.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <script type="importmap">
      {
        "imports": {
          "@material/web/": "https://esm.run/@material/web/"
        }
      }
    </script>

    <script type="module">
      //   import { MDCDataTable } from "@material/data-table";
      import "@material/web/all.js";
      import { styles as typescaleStyles } from "@material/web/typography/md-typescale-styles.js";
      import {
        LitElement,
        html,
        css,
        createRef,
        ref,
      } from "https://cdn.jsdelivr.net/gh/lit/dist@3/all/lit-all.min.js";
      // } from "https://cdn.jsdelivr.net/gh/lit/dist@3/core/lit-core.min.js";

      document.adoptedStyleSheets.push(typescaleStyles.styleSheet);

      export class SheetView extends LitElement {
        dataTableRef = createRef();

        constructor() {
          super();
        }

        static properties = {
          sheets: {
            attribute: true,
            type: Array,
          },
        };

        static styles = css`
          @use "@material/checkbox";
          @use "@material/icon-button";
          @use "@material/data-table/data-table";

          @include checkbox.core-styles;
          @include icon-button.core-styles;
          @include data-table.core-styles;
          @include data-table.theme-baseline;
        `;

        render() {
          return html`
            <div class="mdc-data-table" ${ref(this.dataTableRef)}>
              <div class="mdc-data-table__table-container">
                <table
                  class="mdc-data-table__table"
                  aria-label="Dessert calories"
                >
                  <thead>
                    <tr class="mdc-data-table__header-row">
                      <th
                        class="mdc-data-table__header-cell mdc-data-table__header-cell--checkbox"
                        role="columnheader"
                        scope="col"
                      >
                        <div
                          class="mdc-checkbox mdc-data-table__header-row-checkbox mdc-checkbox--selected"
                        >
                          <input
                            type="checkbox"
                            class="mdc-checkbox__native-control"
                            aria-label="Toggle all rows"
                          />
                          <div class="mdc-checkbox__background">
                            <svg
                              class="mdc-checkbox__checkmark"
                              viewBox="0 0 24 24"
                            >
                              <path
                                class="mdc-checkbox__checkmark-path"
                                fill="none"
                                d="M1.73,12.91 8.1,19.28 22.79,4.59"
                              />
                            </svg>
                            <div class="mdc-checkbox__mixedmark"></div>
                          </div>
                          <div class="mdc-checkbox__ripple"></div>
                        </div>
                      </th>
                      <th
                        class="mdc-data-table__header-cell"
                        role="columnheader"
                        scope="col"
                      >
                        Signal name
                      </th>
                      <th
                        class="mdc-data-table__header-cell"
                        role="columnheader"
                        scope="col"
                      >
                        Status
                      </th>
                      <th
                        class="mdc-data-table__header-cell"
                        role="columnheader"
                        scope="col"
                      >
                        Severity
                      </th>
                      <th
                        class="mdc-data-table__header-cell"
                        role="columnheader"
                        scope="col"
                      >
                        Stage
                      </th>
                      <th
                        class="mdc-data-table__header-cell mdc-data-table__header-cell--numeric"
                        role="columnheader"
                        scope="col"
                      >
                        Time
                      </th>
                      <th
                        class="mdc-data-table__header-cell"
                        role="columnheader"
                        scope="col"
                      >
                        Roles
                      </th>
                    </tr>
                  </thead>
                  <tbody class="mdc-data-table__content">
                    <tr data-row-id="u0" class="mdc-data-table__row">
                      <td
                        class="mdc-data-table__cell mdc-data-table__cell--checkbox"
                      >
                        <div class="mdc-checkbox mdc-data-table__row-checkbox">
                          <input
                            type="checkbox"
                            class="mdc-checkbox__native-control"
                            aria-labelledby="u0"
                          />
                          <div class="mdc-checkbox__background">
                            <svg
                              class="mdc-checkbox__checkmark"
                              viewBox="0 0 24 24"
                            >
                              <path
                                class="mdc-checkbox__checkmark-path"
                                fill="none"
                                d="M1.73,12.91 8.1,19.28 22.79,4.59"
                              />
                            </svg>
                            <div class="mdc-checkbox__mixedmark"></div>
                          </div>
                          <div class="mdc-checkbox__ripple"></div>
                        </div>
                      </td>
                      <th class="mdc-data-table__cell" scope="row" id="u0">
                        Arcus watch slowdown
                      </th>
                      <td class="mdc-data-table__cell">Online</td>
                      <td class="mdc-data-table__cell">Medium</td>
                      <td class="mdc-data-table__cell">Triaged</td>
                      <td
                        class="mdc-data-table__cell mdc-data-table__cell--numeric"
                      >
                        0:33
                      </td>
                      <td class="mdc-data-table__cell">Allison Brie</td>
                    </tr>
                    <tr
                      data-row-id="u1"
                      class="mdc-data-table__row mdc-data-table__row--selected"
                      aria-selected="true"
                    >
                      <td
                        class="mdc-data-table__cell mdc-data-table__cell--checkbox"
                      >
                        <div
                          class="mdc-checkbox mdc-data-table__row-checkbox mdc-checkbox--selected"
                        >
                          <input
                            type="checkbox"
                            class="mdc-checkbox__native-control"
                            checked
                            aria-labelledby="u1"
                          />
                          <div class="mdc-checkbox__background">
                            <svg
                              class="mdc-checkbox__checkmark"
                              viewBox="0 0 24 24"
                            >
                              <path
                                class="mdc-checkbox__checkmark-path"
                                fill="none"
                                d="M1.73,12.91 8.1,19.28 22.79,4.59"
                              />
                            </svg>
                            <div class="mdc-checkbox__mixedmark"></div>
                          </div>
                          <div class="mdc-checkbox__ripple"></div>
                        </div>
                      </td>
                      <th class="mdc-data-table__cell" scope="row" id="u1">
                        monarch: prod shared
                        ares-managed-features-provider-heavy
                      </th>
                      <td class="mdc-data-table__cell">Offline</td>
                      <td class="mdc-data-table__cell">Huge</td>
                      <td class="mdc-data-table__cell">Triaged</td>
                      <td
                        class="mdc-data-table__cell mdc-data-table__cell--numeric"
                      >
                        0:33
                      </td>
                      <td class="mdc-data-table__cell">Brie Larson</td>
                    </tr>
                    <tr
                      data-row-id="u2"
                      class="mdc-data-table__row mdc-data-table__row--selected"
                      aria-selected="true"
                    >
                      <td
                        class="mdc-data-table__cell mdc-data-table__cell--checkbox"
                      >
                        <div
                          class="mdc-checkbox mdc-data-table__row-checkbox mdc-checkbox--selected"
                        >
                          <input
                            type="checkbox"
                            class="mdc-checkbox__native-control"
                            checked
                            aria-labelledby="u2"
                          />
                          <div class="mdc-checkbox__background">
                            <svg
                              class="mdc-checkbox__checkmark"
                              viewBox="0 0 24 24"
                            >
                              <path
                                class="mdc-checkbox__checkmark-path"
                                fill="none"
                                d="M1.73,12.91 8.1,19.28 22.79,4.59"
                              />
                            </svg>
                            <div class="mdc-checkbox__mixedmark"></div>
                          </div>
                          <div class="mdc-checkbox__ripple"></div>
                        </div>
                      </td>
                      <th class="mdc-data-table__cell" scope="row" id="u2">
                        monarch: prod shared
                        ares-managed-features-provider-heavy
                      </th>
                      <td class="mdc-data-table__cell">Online</td>
                      <td class="mdc-data-table__cell">Minor</td>
                      <td class="mdc-data-table__cell">Not triaged</td>
                      <td
                        class="mdc-data-table__cell mdc-data-table__cell--numeric"
                      >
                        0:33
                      </td>
                      <td class="mdc-data-table__cell">Jeremy Lake</td>
                    </tr>
                    <tr data-row-id="u3" class="mdc-data-table__row">
                      <td
                        class="mdc-data-table__cell mdc-data-table__cell--checkbox"
                      >
                        <div class="mdc-checkbox mdc-data-table__row-checkbox">
                          <input
                            type="checkbox"
                            class="mdc-checkbox__native-control"
                            aria-labelledby="u3"
                          />
                          <div class="mdc-checkbox__background">
                            <svg
                              class="mdc-checkbox__checkmark"
                              viewBox="0 0 24 24"
                            >
                              <path
                                class="mdc-checkbox__checkmark-path"
                                fill="none"
                                d="M1.73,12.91 8.1,19.28 22.79,4.59"
                              />
                            </svg>
                            <div class="mdc-checkbox__mixedmark"></div>
                          </div>
                          <div class="mdc-checkbox__ripple"></div>
                        </div>
                      </td>
                      <th class="mdc-data-table__cell" scope="row" id="u3">
                        Arcus watch slowdown
                      </th>
                      <td class="mdc-data-table__cell">Online</td>
                      <td class="mdc-data-table__cell">Negligible</td>
                      <td class="mdc-data-table__cell">Triaged</td>
                      <td
                        class="mdc-data-table__cell mdc-data-table__cell--numeric"
                      >
                        0:33
                      </td>
                      <td class="mdc-data-table__cell">Angelina Cheng</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          `;
          return html`<div class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect">
            ${this.sheets.map((sheet) => {
              const headerValues = sheet.data[0].rowData[0];
              console.log(headerValues);

              return html`<div
                  class="mdl-tabs__panel is-active"
                  id="${sheet.properties.sheetId}"
                >
                  <table
                    class="mdl-data-table mdl-js-data-table mdl-data-table--selectable mdl-shadow--2dp"
                  >
                    <thead>
                      <tr>
                        ${headerValues.values.map((cell) => {
                          return html`
                            <th class="mdl-data-table__cell--non-numeric">
                              ${cell.formattedValue}
                            </th>
                          `;
                        })}
                      </tr>
                    </thead>
                    <tbody>
                      ${sheet.data[0].rowData.map((row) => {
                        return html`
                          <tr>
                            ${row.values.map((cell) => {
                              return html`<td
                                class="mdl-data-table__cell--non-numeric"
                              >
                                ${cell.formattedValue}
                              </td>`;
                            })}
                          </tr>
                        `;
                      })}
                    </tbody>
                  </table>
                </div>

                <div class="mdl-tabs__tab-bar">
                  ${this.sheets.map((sheet) => {
                    return html`
                      <a
                        href="#${sheet.properties.sheetId}"
                        class="mdl-tabs__tab is-active"
                        >${sheet.properties.title}</a
                      >
                    `;
                  })}
                </div>`;
            })}
          </div>`;
        }

        async connectedCallback() {
          super.connectedCallback();
          //   componentHandler.upgradeElement(this);

          const dataTable = new mdc.dataTable.MDCDataTable(
            this.dataTableRef
            // this.renderRoot.querySelector(".mdc-data-table")
          );
          console.log(dataTable);

          return;
        }
      }
      customElements.define("sheet-view", SheetView);

      export class PickerView extends LitElement {
        constructor() {
          super();

          google.script.run
            .withSuccessHandler((token) => {
              this.oauthToken = token;
            })
            .withFailureHandler(showError)
            .getOAuthToken();
        }

        static properties = {
          apiKey: {
            attribute: true,
            type: String,
          },
          appId: {
            attribute: true,
            type: String,
          },
          oauthToken: {
            attribute: true,
            type: String,
          },
        };

        static styles = css`
          :host {
            display: block;
            padding: 16px;
          }
        `;

        connectedCallback() {
          super.connectedCallback();
          console.log("PickerView connected:", this.apiKey, this.appId);
          console.log("OAuth token:", this.oauthToken);
        }

        render() {
          return html`<div>
            <slot></slot>
          </div>`;
        }
      }
      customElements.define("picker-view", PickerView);

      function googleScriptRun(name, ...args) {
        return new Promise(function (resolve, reject) {
          console.log(
            `Executes the server-side Apps Script function "${name}"`,
            args
          );
          google.script.run
            .withSuccessHandler(function (...e) {
              console.log(
                `The server-side function "${name}" returns successfully.`,
                e
              );
              resolve(...e);
            })
            .withFailureHandler(function (...e) {
              console.log(
                `The server-side function "${name}" throws an exception.`,
                e
              );
              reject(...e);
            })
            [name](...args);
        });
      }
    </script>

    <script>
      // TODO: Replace the value for DEVELOPER_KEY with the API key obtained
      // from the Google Developers Console.
      const DEVELOPER_KEY = "<? getApiKey() ?>";
      // TODO: Replace the value for CLOUD_PROJECT_NUMBER with the project
      // number obtained from the Google Developers Console.
      const CLOUD_PROJECT_NUMBER = "<? getAppId() ?>";

      let pickerApiLoaded = false;
      let oauthToken;

      /**
       * Loads the Google Picker API.
       */
      function onApiLoad() {
        gapi.load("picker", {
          callback: function () {
            pickerApiLoaded = true;
          },
        });
      }

      /**
       * Gets the user's OAuth 2.0 access token from the server-side script so that
       * it can be passed to Picker. This technique keeps Picker from needing to
       * show its own authorization dialog, but is only possible if the OAuth scope
       * that Picker needs is available in Apps Script. Otherwise, your Picker code
       * will need to declare its own OAuth scopes.
       */
      function getOAuthToken() {
        google.script.run
          .withSuccessHandler((token) => {
            oauthToken = token;
            createPicker(token);
          })
          .withFailureHandler(showError)
          .getOAuthToken();
      }

      /**
       * Creates a Picker that can access the user's spreadsheets. This function
       * uses advanced options to hide the Picker's left navigation panel and
       * default title bar.
       *
       * @param {string} token An OAuth 2.0 access token that lets Picker access the
       *     file type specified in the addView call.
       */
      function createPicker(token) {
        // document.getElementById("result").innerHTML = "";

        if (pickerApiLoaded && token) {
          const mimeTypes = ["application/vnd.google-apps.spreadsheet"];
          const numItems = 1;

          const picker = new google.picker.PickerBuilder()
            // Instruct Picker to display only spreadsheets in Drive. For other
            // views, see https://developers.google.com/picker/reference/picker.viewid
            .addView(
              new google.picker.DocsView(google.picker.ViewId.SPREADSHEETS)
                .setSelectFolderEnabled(false)
                .setIncludeFolders(false)
                .setEnableDrives(false)
                .setMode(google.picker.DocsViewMode.LIST)
            )
            .addView(
              new google.picker.DocsView(google.picker.ViewId.SPREADSHEETS)
                .setSelectFolderEnabled(false)
                .setIncludeFolders(true)
                .setEnableDrives(true)
                .setMode(google.picker.DocsViewMode.LIST)
            )
            // Hide the navigation panel so that Picker fills more of the dialog.
            // .enableFeature(google.picker.Feature.NAV_HIDDEN)
            // Hide the title bar since an Apps Script dialog already has a title.
            .hideTitleBar()
            .setMaxItems(numItems)
            .setSelectableMimeTypes(mimeTypes.join(","))
            .setOAuthToken(token)
            .setDeveloperKey(DEVELOPER_KEY)
            .setAppId(CLOUD_PROJECT_NUMBER)
            .setCallback(pickerCallback)
            .setOrigin(google.script.host.origin)
            .build();
          picker.setVisible(true);
        } else {
          showError("Unable to load the file picker.");
        }
      }

      /**
       * A callback function that extracts the chosen document's metadata from the
       * response object. For details on the response object, see
       * https://developers.google.com/picker/reference/picker.responseobject
       *
       * @param {object} data The response object.
       */
      function pickerCallback(data) {
        const action = data[google.picker.Response.ACTION];
        if (action == google.picker.Action.PICKED) {
          handlePicked(data);
        } else if (action == google.picker.Action.CANCEL) {
          document.getElementById("result").innerHTML = "Picker canceled.";
        }
      }

      /**
       * Handles `"PICKED"` responsed from the Google Picker.
       *
       * @param {object} data The response object.
       */
      function handlePicked(data) {
        const doc = data[google.picker.Response.DOCUMENTS][0];
        const id = doc[google.picker.Document.ID];

        google.script.run
          .withSuccessHandler((driveFilesGetResponse) => {
            console.log(driveFilesGetResponse);

            // Render the response from Picker and the Drive.Files.Get API.
            const resultElement = document.getElementById("result");
            // resultElement.innerHTML = "";
            resultElement.setAttribute("sheets", driveFilesGetResponse);

            // for (const response of [
            //   {
            //     title: "Picker response",
            //     content: JSON.stringify(data, null, 2),
            //   },
            //   {
            //     title: "Drive.Files.Get response",
            //     content: JSON.stringify(driveFilesGetResponse, null, 2),
            //   },
            // ]) {
            //   const titleElement = document.createElement("h3");
            //   titleElement.appendChild(document.createTextNode(response.title));
            //   resultElement.appendChild(titleElement);

            //   const contentElement = document.createElement("pre");
            //   contentElement.appendChild(
            //     document.createTextNode(response.content)
            //   );
            //   resultElement.appendChild(contentElement);
            // }
          })
          .withFailureHandler(showError)
          .getSpreadsheet(data[google.picker.Response.DOCUMENTS][0].id);
      }

      /**
       * Displays an error message within the #result element.
       *
       * @param {string} message The error message to display.
       */
      function showError(message) {
        document.getElementById("result").innerHTML = "Error: " + message;
      }
    </script>
  </head>

  <body>
    <div>
      <!-- Colored raised button -->
      <button
        class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored"
        onclick="getOAuthToken()"
      >
        Select a file
      </button>
    </div>

    <picker-view
      id="picker"
      api-key="<? getApiKey() ?>"
      app-id="<? getAppId() ?>"
      oauth-token=""
    ></picker-view>
    <sheet-view id="result"></sheet-view>

    <script src="https://apis.google.com/js/api.js?onload=onApiLoad"></script>
  </body>
</html>
