<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />

    <?!= HtmlService.createHtmlOutputFromFile('Imports.html').getContent(); ?>

    <script type="module">
      import "@material/web/all.js";
      import { styles as typescaleStyles } from "@material/web/typography/md-typescale-styles.js";
      import {
        LitElement,
        html,
        css,
        nothing,
      } from "https://cdn.jsdelivr.net/gh/lit/dist@3/core/lit-core.min.js";

      document.adoptedStyleSheets.push(typescaleStyles.styleSheet);

      export class PickerView extends LitElement {
        constructor() {
          super();

          this.apiKey = "<?= getApiKey() ?>";
          this.appId = "<?= getAppId() ?>";
          this.oauthToken = "<?= getOAuthToken() ?>";
        }

        static properties = {
          apiKey: { type: String },
          appId: { type: String },
          oauthToken: { type: String },
          picker: { type: Object },
        };

        static styles = css``;

        connectedCallback() {
          super.connectedCallback();
          this.createPicker();
        }

        disconnectedCallback() {
          super.disconnectedCallback();
          this.picker?.dispose();
        }

        render() {
          return html`
            ${this.picker?.isVisible()
              ? nothing
              : html`
                  <md-circular-progress
                    four-color
                    indeterminate
                  ></md-circular-progress>
                `}
          `;
        }

        createPicker() {
          if (pickerApiLoaded && this.oauthToken) {
            const mimeTypes = ["application/vnd.google-apps.spreadsheet"];
            const numItems = 1;
            const width = this.parentElement.offsetWidth - 24;
            const height = this.parentElement.offsetHeight - 72;

            this.picker = new google.picker.PickerBuilder()
              .hideTitleBar()
              .setLocale(navigator.languages[0])
              .setMaxItems(numItems)
              .setSelectableMimeTypes(mimeTypes.join(","))
              .setOAuthToken(this.oauthToken)
              .setDeveloperKey(this.apiKey)
              .setAppId(this.appId)
              .setCallback((responseObject) => {
                const action = responseObject[google.picker.Response.ACTION];
                if (action == google.picker.Action.PICKED) {
                  this.handlePicked(responseObject);
                } else if (action == google.picker.Action.CANCEL) {
                  this.closePickerDialog();
                } else if (action == google.picker.Action.ERROR) {
                  console.log("Error");
                }
              })
              .setOrigin(google.script.host.origin)
              .setSize(width, height)
              .addView(
                new google.picker.DocsView(google.picker.ViewId.SPREADSHEETS)
                  .setSelectFolderEnabled(false)
                  .setIncludeFolders(false)
                  .setEnableDrives(false)
                  .setMode(google.picker.DocsViewMode.LIST)
              )
              .addView(
                new google.picker.DocsView(google.picker.ViewId.SPREADSHEETS)
                  .setSelectFolderEnabled(false)
                  .setIncludeFolders(true)
                  .setEnableDrives(true)
                  .setMode(google.picker.DocsViewMode.LIST)
              )
              .build();
            this.picker.setVisible(true);
          } else {
            console.log("Unable to load the file picker.");
          }
        }

        handlePicked(responseObject) {
          const doc = responseObject[google.picker.Response.DOCUMENTS][0];
          const context = {
            picked: {
              url: doc[google.picker.Document.URL],
              iconUrl: doc[google.picker.Document.ICON_URL],
              id: doc[google.picker.Document.ID],
              name: doc[google.picker.Document.NAME],
              parentId: doc[google.picker.Document.PARENT_ID],
              lastEditedUtc: doc[google.picker.Document.LAST_EDITED_UTC],
              description: doc[google.picker.Document.DESCRIPTION],
            },
          };
          this.openSidebar(context);
        }

        openSidebar(context) {
          googleScriptRun("openSidebar", context).then(() => {
            this.closePickerDialog();
          });
        }

        closePickerDialog() {
          google.script.host.close();
        }
      }
      customElements.define("picker-view", PickerView);
    </script>

    <script>
      let pickerApiLoaded = false;

      function onApiLoad() {
        gapi.load("picker", {
          callback: function () {
            pickerApiLoaded = true;
          },
        });
      }
    </script>

    <style>
      html,
      body,
      iframe {
        width: 100vw;
        height: 100vh;
        overflow: hidden;
      }
    </style>
  </head>

  <body>
    <picker-view></picker-view>
    <script src="https://apis.google.com/js/api.js?onload=onApiLoad"></script>
  </body>
</html>
