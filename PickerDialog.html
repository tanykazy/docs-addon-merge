<!doctype html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />

    <?!= include_('Imports.html'); ?>

    <!-- Add-ons1.css -->
    <link
      href="https://ssl.gstatic.com/docs/script/css/add-ons1.css"
      rel="stylesheet"
    />

    <!-- Material Components -->
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script type="importmap">
      {
        "imports": {
          "@material/web/": "https://esm.run/@material/web/"
        }
      }
    </script>
    <script type="module">
      import "@material/web/all.js";
      import { styles as typescaleStyles } from "@material/web/typography/md-typescale-styles.js";
      import {
        LitElement,
        html,
        css,
        nothing,
      } from "https://cdn.jsdelivr.net/gh/lit/dist@3/core/lit-core.min.js";

      document.adoptedStyleSheets.push(typescaleStyles.styleSheet);

      export class PickerView extends LitElement {
        constructor() {
          super();

          this.dialogOpen = false;

          this.apiKey = "<?= getApiKey() ?>";
          this.appId = "<?= getAppId() ?>";
          this.oauthToken = "<?= getOAuthToken() ?>";
        }

        static properties = {
          apiKey: { type: String },
          appId: { type: String },
          oauthToken: { type: String },
          picker: { type: Object },
          dialogOpen: { type: Boolean },
        };

        static styles = css``;

        connectedCallback() {
          super.connectedCallback();
          this.createPicker();
        }

        disconnectedCallback() {
          super.disconnectedCallback();
          this.picker?.dispose();
        }

        render() {
          return html`
            ${this.picker?.isVisible()
              ? nothing
              : html`
                  <md-dialog type="alert" ?open=${this.dialogOpen}>
                    <div slot="headline">Google Picker Error</div>
                    <form id="form" slot="content" method="dialog">
                      <span>
                        Google 選択ツール ダイアログでエラーが発生しました。
                      </span>
                    </form>
                    <div slot="actions">
                      <md-text-button
                        form="form"
                        value="ok"
                        @click=${this.closePickerDialog}
                      >
                        OK
                      </md-text-button>
                    </div>
                  </md-dialog>
                `}
          `;
        }

        /**
         * Create picker
         */
        createPicker() {
          this.picker = createPicker(this.oauthToken, this.apiKey, this.appId);
          this.picker.setCallback((responseObject) => {
            const action = responseObject[google.picker.Response.ACTION];
            if (action == google.picker.Action.PICKED) {
              this.handlePicked(responseObject);
            } else if (action == google.picker.Action.CANCEL) {
              this.closePickerDialog();
            } else if (action == google.picker.Action.ERROR) {
              this.picker.setVisible(false);
              this.dialogOpen = true;
            }
          });
          this.picker.setVisible(true);
          this.dialogOpen = false;
        }

        /**
         * Handle picked
         * @param {google.picker.Response} responseObject
         */
        handlePicked(responseObject) {
          const doc = responseObject[google.picker.Response.DOCUMENTS][0];
          const context = {
            picked: {
              url: doc[google.picker.Document.URL],
              iconUrl: doc[google.picker.Document.ICON_URL],
              id: doc[google.picker.Document.ID],
              name: doc[google.picker.Document.NAME],
              parentId: doc[google.picker.Document.PARENT_ID],
              lastEditedUtc: doc[google.picker.Document.LAST_EDITED_UTC],
              description: doc[google.picker.Document.DESCRIPTION],
            },
          };
          this.openSidebar(context);
        }

        /**
         * Open sidebar
         * @param {Object} context
         */
        openSidebar(context) {
          googleScriptRun("openSidebar", context).then(() => {
            this.closePickerDialog();
          });
        }

        /**
         * Close picker dialog
         */
        closePickerDialog() {
          google.script.host.close();
        }
      }
      customElements.define("picker-view", PickerView);
    </script>

    <script>
      /**
       * Picker API loaded
       * @type {boolean}
       */
      let pickerApiLoaded = false;

      /**
       * On API load
       */
      function onApiLoad() {
        gapi.load("picker", {
          callback: function () {
            pickerApiLoaded = true;
          },
        });
      }

      /**
       * Create picker
       * @param {string} oauthToken
       * @param {string} apiKey
       * @param {string} appId
       * @returns {google.picker.Picker}
       */
      function createPicker(oauthToken, apiKey, appId) {
        if (!pickerApiLoaded) {
          throw new Error("Picker API not loaded");
        }
        const mimeTypes = ["application/vnd.google-apps.spreadsheet"];
        const numItems = 1;
        const width = document.body.offsetWidth - 24;
        const height = document.body.offsetHeight - 72;

        const picker = new google.picker.PickerBuilder()
          .hideTitleBar()
          .setLocale(navigator.languages[0])
          .setMaxItems(numItems)
          .setSelectableMimeTypes(mimeTypes.join(","))
          .setOAuthToken(oauthToken)
          .setDeveloperKey(apiKey)
          .setAppId(appId)
          .setOrigin(google.script.host.origin)
          .setSize(width, height)
          .addView(
            new google.picker.DocsView(google.picker.ViewId.SPREADSHEETS)
              .setSelectFolderEnabled(false)
              .setIncludeFolders(false)
              .setEnableDrives(false)
              .setMode(google.picker.DocsViewMode.LIST),
          )
          .addView(
            new google.picker.DocsView(google.picker.ViewId.DOCS)
              .setSelectFolderEnabled(false)
              .setIncludeFolders(true)
              .setOwnedByMe(true)
              .setMode(google.picker.DocsViewMode.LIST),
          )
          .addView(
            new google.picker.DocsView(google.picker.ViewId.DOCS)
              .setSelectFolderEnabled(false)
              .setIncludeFolders(true)
              .setEnableDrives(true)
              .setMode(google.picker.DocsViewMode.LIST),
          )
          .build();
        return picker;
      }
    </script>

    <style>
      body {
        height: 100vh;
      }
    </style>
  </head>

  <body>
    <picker-view></picker-view>
    <script src="https://apis.google.com/js/api.js?onload=onApiLoad"></script>
  </body>
</html>
