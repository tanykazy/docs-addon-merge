<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />

    <link
      rel="stylesheet"
      href="https://ssl.gstatic.com/docs/script/css/add-ons.css"
    />
    <link
      href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <script type="importmap">
      {
        "imports": {
          "@material/web/": "https://esm.run/@material/web/"
        }
      }
    </script>

    <script type="module">
      import "@material/web/all.js";
      import { styles as typescaleStyles } from "@material/web/typography/md-typescale-styles.js";
      import {
        LitElement,
        html,
        css,
        nothing,
      } from "https://cdn.jsdelivr.net/gh/lit/dist@3/core/lit-core.min.js";

      document.adoptedStyleSheets.push(typescaleStyles.styleSheet);

      export class PickerView extends LitElement {
        constructor() {
          super();

          this.apiKey = "<?= getApiKey() ?>";
          this.appId = "<?= getAppId() ?>";
          this.oauthToken = "<?= getOAuthToken() ?>";
        }

        static properties = {
          apiKey: { type: String },
          appId: { type: String },
          oauthToken: { type: String },
          picker: { type: Object },
        };

        static styles = css``;

        connectedCallback() {
          super.connectedCallback();
          this.createPicker();
        }

        disconnectedCallback() {
          super.disconnectedCallback();
          this.picker?.dispose();
        }

        render() {
          return html`
            ${this.picker?.isVisible()
              ? nothing
              : html`
                  <md-circular-progress indeterminate></md-circular-progress>
                `}
          `;
        }

        /**
         * Creates a Picker that can access the user's spreadsheets. This function
         * uses advanced options to hide the Picker's left navigation panel and
         * default title bar.
         */
        createPicker() {
          if (pickerApiLoaded && this.oauthToken) {
            const mimeTypes = ["application/vnd.google-apps.spreadsheet"];
            const numItems = 1;
            const width = this.parentElement.offsetWidth - 24;
            const height = this.parentElement.offsetHeight - 72;

            this.picker = new google.picker.PickerBuilder()
              // Hide the navigation panel so that Picker fills more of the dialog.
              // .enableFeature(google.picker.Feature.NAV_HIDDEN)
              // Hide the title bar since an Apps Script dialog already has a title.
              .hideTitleBar()
              .setLocale(navigator.languages[0])
              .setMaxItems(numItems)
              .setSelectableMimeTypes(mimeTypes.join(","))
              .setOAuthToken(this.oauthToken)
              .setDeveloperKey(this.apiKey)
              .setAppId(this.appId)
              .setCallback((responseObject) => {
                const action = responseObject[google.picker.Response.ACTION];
                if (action == google.picker.Action.PICKED) {
                  this.handlePicked(responseObject);
                } else if (action == google.picker.Action.CANCEL) {
                  console.log("Picker canceled.");
                  this.closePickerDialog();
                } else if (action == google.picker.Action.ERROR) {
                  console.log("Error");
                }
              })
              .setOrigin(google.script.host.origin)
              .setSize(width, height)
              // Instruct Picker to display only spreadsheets in Drive. For other
              // views, see https://developers.google.com/picker/reference/picker.viewid
              .addView(
                new google.picker.DocsView(google.picker.ViewId.SPREADSHEETS)
                  .setSelectFolderEnabled(false)
                  .setIncludeFolders(false)
                  .setEnableDrives(false)
                  .setMode(google.picker.DocsViewMode.LIST)
              )
              .addView(
                new google.picker.DocsView(google.picker.ViewId.SPREADSHEETS)
                  .setSelectFolderEnabled(false)
                  .setIncludeFolders(true)
                  .setEnableDrives(true)
                  .setMode(google.picker.DocsViewMode.LIST)
              )
              .build();
            this.picker.setVisible(true);
          } else {
            this.showError("Unable to load the file picker.");
          }
        }

        /**
         * Handles `"PICKED"` responsed from the Google Picker.
         *
         * @param {object} responseObject The response object.
         */
        handlePicked(responseObject) {
          console.log(responseObject);
          this.openSidebar(responseObject);
        }

        openSidebar(context) {
          google.script.run
            .withSuccessHandler((response) => {
              console.log(response);
              this.closePickerDialog();
            })
            .withFailureHandler((...e) => {
              console.log(`The server-side function throws an exception.`, e);
            })
            .openSidebar(context);
        }

        closePickerDialog() {
          google.script.host.close();
        }

        /**
         * Displays an error message within the #result element.
         *
         * @param {string} message The error message to display.
         */
        showError(message) {
          console.error("Error:", message);
        }
      }
      customElements.define("picker-view", PickerView);

      function googleScriptRun(name, ...args) {
        return new Promise(function (resolve, reject) {
          console.log(
            `Executes the server-side Apps Script function "${name}"`,
            args
          );
          google.script.run
            .withSuccessHandler(function (...e) {
              console.log(
                `The server-side function "${name}" returns successfully.`,
                e
              );
              resolve(...e);
            })
            .withFailureHandler(function (...e) {
              console.log(
                `The server-side function "${name}" throws an exception.`,
                e
              );
              reject(...e);
            })
            [name](...args);
        });
      }
    </script>
  </head>

  <script>
    let pickerApiLoaded = false;

    function onApiLoad() {
      gapi.load("picker", {
        callback: function () {
          pickerApiLoaded = true;
        },
      });
    }
  </script>

  <style>
    html,
    body,
    iframe {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
  </style>

  <body>
    <picker-view></picker-view>
    <script src="https://apis.google.com/js/api.js?onload=onApiLoad"></script>
  </body>
</html>
