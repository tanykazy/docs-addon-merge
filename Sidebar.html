<!doctype html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />

    <?!= include_('Imports.html'); ?>

    <!-- Add-ons1.css -->
    <link
      href="https://ssl.gstatic.com/docs/script/css/add-ons1.css"
      rel="stylesheet"
    />

    <!-- Material Components -->
    <link
      href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />

    <!-- Roboto -->
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script type="importmap">
      {
        "imports": {
          "@material/web/": "https://esm.run/@material/web/"
        }
      }
    </script>
    <script type="module">
      import "@material/web/all.js";
      import { styles as typescaleStyles } from "@material/web/typography/md-typescale-styles.js";
      import {
        LitElement,
        html,
        css,
        nothing,
      } from "https://cdn.jsdelivr.net/gh/lit/dist@3/core/lit-core.min.js";

      document.adoptedStyleSheets.push(typescaleStyles.styleSheet);

      export class SidebarView extends LitElement {
        constructor() {
          super();

          this.isSpreadsheetLoading = false;
          this.isHeaderRowLoading = false;
        }

        static properties = {
          context: {
            type: Object,
            converter: {
              fromAttribute(value) {
                try {
                  return JSON.parse(value);
                } catch (error) {
                  console.error("Failed to parse context JSON:", error);
                  return null;
                }
              },
              toAttribute(value) {
                return JSON.stringify(value);
              },
            },
          },
          isSpreadsheetLoading: { type: Boolean },
          isHeaderRowLoading: { type: Boolean },
          mdcSnackbar: { type: Object },
        };

        static styles = css`
          header {
            display: flex;
            flex-direction: column;
          }
          main {
            flex: 1;
            overflow-y: auto;
          }
          footer {
            bottom: 0;
          }
          .width-full {
            width: 100%;
          }
          #container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            gap: 1em;
          }
          #footer-buttons {
            text-align: right;
            margin-left: 1em;
            margin-right: 1em;
            margin-bottom: 1em;
          }
          md-list,
          md-list-item {
            --md-list-container-color: transparent;
            --md-list-item-label-text-font: 12px;
          }
        `;

        render() {
          return html`
            <div class="sidebar" id="container">
              <header>
                <md-list>
                  <md-list-item>
                    <div slot="supporting-text">
                      <span>データソース</span>
                    </div>
                    <md-icon-button
                      slot="end"
                      @click=${this.onClickSpreadsheetRefreshButton}
                      title="データソースを再読み込み"
                    >
                      <md-icon>refresh</md-icon>
                    </md-icon-button>
                  </md-list-item>
                  <md-divider></md-divider>
                  <md-list-item>
                    <img
                      slot="start"
                      style="width: 16px"
                      .src=${this.context.picked.iconUrl}
                    />
                    <div slot="headline">${this.context.picked.name}</div>

                    <md-icon-button
                      slot="end"
                      href=${this.context.picked.url}
                      target="_blank"
                      title="データソースを開く"
                    >
                      <md-icon>open_in_new</md-icon>
                    </md-icon-button>
                  </md-list-item>
                </md-list>
                ${this.isSpreadsheetLoading
                  ? html`
                      <md-circular-progress four-color indeterminate>
                      </md-circular-progress>
                    `
                  : html`
                      <md-filled-select
                        class="width-full"
                        label="シート"
                        @change=${this.onChangeSheet}
                      >
                        ${!this.context.spreadsheet?.sheets
                          ? nothing
                          : this.context.spreadsheet.sheets.map((sheet) => {
                              return html`
                                <md-select-option
                                  .value=${sheet.properties.sheetId}
                                  .selected=${!this.context.sheet
                                    ? false
                                    : this.context.sheet.properties.sheetId ===
                                        sheet.properties.sheetId
                                      ? true
                                      : false}
                                >
                                  <div slot="headline">
                                    ${sheet.properties.title}
                                  </div>
                                </md-select-option>
                              `;
                            })}
                      </md-filled-select>
                    `}
              </header>

              <main>
                ${this.isHeaderRowLoading
                  ? html`
                      <md-circular-progress four-color indeterminate>
                      </md-circular-progress>
                    `
                  : !this.context.headerRow
                    ? nothing
                    : html`
                        <md-list>
                          <md-list-item>
                            <div slot="supporting-text">
                              <span>フィールドコード</span>
                            </div>
                          </md-list-item>
                          <md-divider></md-divider>
                          ${this.context.headerRow[0].map((value) => {
                            const warning =
                              this.context.headerRow[0].filter((header) => {
                                return header === value;
                              }).length > 1;
                            const fieldCode = toFieldCode(value);
                            return html`${!value
                              ? nothing
                              : html`
                                  <md-list-item type="text">
                                    <div slot="headline">${fieldCode}</div>
                                    ${warning
                                      ? html`
                                          <div slot="supporting-text">
                                            <span>列名が重複しています</span>
                                          </div>
                                        `
                                      : nothing}
                                    ${warning
                                      ? html`
                                          <md-icon slot="start"
                                            >warning</md-icon
                                          >
                                        `
                                      : html`
                                          <md-icon-button
                                            slot="end"
                                            @click=${this.onClickFieldCode.bind(
                                              this,
                                              fieldCode,
                                            )}
                                            title="フィールドコードをコピー"
                                          >
                                            <md-icon>content_copy</md-icon>
                                          </md-icon-button>
                                        `}
                                  </md-list-item>
                                `}`;
                          })}
                        </md-list>
                      `}
              </main>

              <footer>
                <div id="footer-buttons">
                  <md-text-button @click=${this.onClickCloseSidebarButton}>
                    <span>戻る</span>
                  </md-text-button>
                  <md-filled-tonal-button
                    ?disabled=${!this.context.spreadsheet ||
                    !this.context.sheet ||
                    !this.context.headerRow}
                    @click=${this.onClickOpenMergeDialogButton}
                  >
                    <span>次へ</span>
                  </md-filled-tonal-button>
                </div>
              </footer>
            </div>
            <slot></slot>
          `;
        }

        connectedCallback() {
          super.connectedCallback();

          if (!this.context.spreadsheet) {
            this.getSpreadsheet();
          }

          console.log(this.refreshButtonRef);
          this.refreshButtonRef.labels = [document.createElement("span")];
          this.refreshButtonRef.labels[0].textContent = "test";
          console.log(this.refreshButtonRef.labels);

          const snackbar = document.querySelector(".mdc-snackbar");
          this.mdcSnackbar = new mdc.snackbar.MDCSnackbar(snackbar);
        }

        disconnectedCallback() {
          super.disconnectedCallback();
        }

        /**
         * Open merge dialog
         * @param {Event} event
         */
        onClickOpenMergeDialogButton(event) {
          this.openMergeDialog();
        }

        /**
         * Close sidebar
         * @param {Event} event
         */
        onClickCloseSidebarButton(event) {
          this.openPickerDialog();
        }

        /**
         * Change sheet
         * @param {Event} event
         */
        onChangeSheet(event) {
          const value = event.target.selectedOptions[0].value;
          this.context.sheet = this.context.spreadsheet.sheets.find(
            (sheet) => sheet.properties.sheetId === value,
          );

          this.getHeaderRow(
            this.context.spreadsheet.spreadsheetId,
            this.context.sheet.properties.sheetId,
          );
        }

        /**
         * Copy field code to clipboard
         * @param {string} fieldCode
         * @param {Event} event
         */
        onClickFieldCode(fieldCode, event) {
          writeTextToClipboard(fieldCode).then(() => {
            this.openSnackbar("コピーしました");
          });
        }

        /**
         * Refresh spreadsheet
         * @param {Event} event
         */
        onClickSpreadsheetRefreshButton(event) {
          this.getSpreadsheet();

          this.context.sheet = null;
          this.context.headerRow = null;
        }

        /**
         * Get spreadsheet
         */
        getSpreadsheet() {
          this.isSpreadsheetLoading = true;

          googleScriptRun("getSpreadsheet", this.context.picked.id).then(
            (spreadsheet) => {
              this.isSpreadsheetLoading = false;

              this.context.spreadsheet = spreadsheet;
            },
          );
        }

        /**
         * Get header row
         * @param {string} spreadsheetId
         * @param {string} sheetId
         */
        getHeaderRow(spreadsheetId, sheetId) {
          this.isHeaderRowLoading = true;

          googleScriptRun(
            "getSheetValues",
            spreadsheetId,
            sheetId,
            0,
            1,
            0,
          ).then((response) => {
            this.isHeaderRowLoading = false;

            const valueRange = response.valueRanges[0].valueRange;
            this.context.headerRow = valueRange.values;
          });
        }

        /**
         * Open merge dialog
         */
        openMergeDialog() {
          this.context.fieldCodes = {};
          const header = this.context.headerRow[0];
          const length = header.length;
          for (let index = 0; index < length; index++) {
            const value = header[index];
            this.context.fieldCodes[value] = toFieldCode(value);
          }

          googleScriptRun("openMergeDialog", this.context);
        }

        /**
         * Open picker dialog
         */
        openPickerDialog() {
          googleScriptRun("openPickerDialog").then(() => {
            this.closeSidebar();
          });
        }

        /**
         * Open snackbar
         * @param {string} labelText
         */
        openSnackbar(labelText) {
          this.mdcSnackbar.labelText = labelText;
          this.mdcSnackbar.open();
        }

        /**
         * Close sidebar
         */
        closeSidebar() {
          google.script.host.close();
        }
      }
      customElements.define("sidebar-view", SidebarView);

      /**
       * Convert value to field code
       * @param {string} value
       * @returns {string}
       */
      function toFieldCode(value) {
        return `{{${value}}}`;
      }

      /**
       * Write text to clipboard
       * @param {string} text
       * @returns {Promise<void>}
       */
      function writeTextToClipboard(text) {
        return navigator.clipboard.writeText(text);
      }
    </script>
  </head>

  <body>
    <sidebar-view context="<?= context ?>">
      <aside class="mdc-snackbar">
        <div
          class="mdc-snackbar__surface"
          role="status"
          aria-relevant="additions"
        >
          <div class="mdc-snackbar__label" aria-atomic="false">
            <span></span>
          </div>
        </div>
      </aside>
    </sidebar-view>
  </body>
</html>
